rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Allow reading user profiles if signed in
      allow read: if isSignedIn();
      
      // Allow creating a user profile only for the user themselves
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Allow updating a profile only for the user themselves, but don't let them edit their friends list
      allow update: if isSignedIn() && request.auth.uid == userId
                    && !("friends" in request.resource.data);
    }
    
    // --- Friend Requests Collection ---
    match /friend_requests/{requestId} {
        // Allow read if the user is part of the request
        allow read: if isSignedIn() && request.auth.uid in resource.data.participantIds;
        
        // Allow create if the sender is the current user
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.fromUserId;
        
        // Allow update (decline) if the recipient is the current user. Accept is handled by cloud function.
        allow update: if isSignedIn() && request.auth.uid == resource.data.toUserId;
    }

    // --- Businesses Collection ---
    match /businesses/{businessId} {
      // Allow anyone signed in to read business listings
      allow read: if isSignedIn();
      // Allow creating a business if the user is the owner
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      // Allow updating/deleting only by the owner
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    // --- Posts Collection (includes Events and For Sale items) ---
    match /posts/{postId} {
      // Allow any signed-in user to read any post
      allow read: if isSignedIn();
      
      // Allow creating a post if the user is authenticated and is the author
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;

      // Allow a user to update or delete their own post
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;

      // --- Comments Subcollection ---
      match /comments/{commentId} {
        // Allow any signed-in user to read comments
        allow read: if isSignedIn();
        // Allow any signed-in user to create a comment
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
        // Allow updating (e.g., for reactions) if signed in. Deleting can be added later if needed.
        allow update: if isSignedIn();
      }
    }
    
    // --- Conversations (Chats) Collection ---
    match /conversations/{conversationId} {
        // Allow read/write if the user is a participant in the conversation
        allow read, update, create: if isSignedIn() && request.auth.uid in resource.data.participantIds;
        
        // --- Messages Subcollection ---
        match /messages/{messageId} {
            // Allow read if user is a participant of the parent conversation
            allow read: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
            
            // Allow create if the user is the sender and a participant
            allow create: if isSignedIn() && request.auth.uid == request.resource.data.senderId &&
                             request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
        }
    }

    // --- Notifications Collection ---
    match /notifications/{notificationId} {
        // Only allow a user to read/update their own notifications
        allow read, update: if isSignedIn() && request.auth.uid == resource.data.userId;
        // Do not allow client-side creation of notifications
        allow create: if false;
    }
  }
}

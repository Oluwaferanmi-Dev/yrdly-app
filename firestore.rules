
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    // User Profiles
    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isOwner(userId); // Allow user to create their own profile
      allow update: if isOwner(userId) && request.resource.data.keys().hasOnly(['name', 'bio', 'avatarUrl', 'location', 'fcmToken', 'friends', 'blockedUsers', 'notificationSettings']);
    }

    // Friend Requests
    match /friend_requests/{requestId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow create: if isAuth() && request.auth.uid == request.resource.data.fromUserId;
      allow update: if isAuth() && (
        (request.resource.data.status == 'accepted' && isOwner(resource.data.toUserId)) ||
        (request.resource.data.status == 'declined' && isOwner(resource.data.toUserId)) ||
        (resource.data.status == 'pending' && isOwner(resource.data.fromUserId)) // Allow sender to cancel
      );
      allow delete: if isOwner(resource.data.fromUserId); // Allow sender to delete/cancel
    }
    
    // Businesses
    match /businesses/{businessId} {
      allow get: if isAuth();
      allow list: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth() && isOwner(resource.data.ownerId);
      allow delete: if isAuth() && isOwner(resource.data.ownerId);
    }
    
    // Posts (General, Events, For Sale)
    match /posts/{postId} {
      allow read: if isAuth();
      allow create: if isAuth() && isOwner(request.resource.data.userId);
      allow update: if isAuth() && (
        (isOwner(resource.data.userId)) || // Owner can edit their post
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likedBy', 'attendees'])) || // Anyone can like or RSVP
        (request.resource.data.commentCount == resource.data.commentCount + 1) // Anyone can increment comment count
      );
      allow delete: if isAuth() && isOwner(resource.data.userId);

      // Comments sub-collection
      match /comments/{commentId} {
        allow read: if isAuth();
        allow create: if isAuth(); // Any authenticated user can create a comment
        allow update: if isAuth() && (
          isOwner(resource.data.userId) || // Owner can edit their own comment
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) // Any user can react
        );
        allow delete: if isAuth() && isOwner(resource.data.userId);
      }
    }
    
    // Conversations
    match /conversations/{conversationId} {
      allow read, create: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow update: if isAuth() && request.auth.uid in resource.data.participantIds;

      // Messages sub-collection
      match /messages/{messageId} {
        allow read, create: if isAuth() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
      }
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read: if isAuth() && isOwner(resource.data.userId);
      allow update: if isAuth() && isOwner(resource.data.userId) && request.resource.data.keys().hasOnly(['isRead']);
      // No create/delete from client
    }
    
    // Mail Queue for Emails
    match /mail/{mailId} {
      // Only allow server-side creation (e.g. from cloud functions)
      allow read, write: if false; 
      allow create: if isAuth(); // Allow client to trigger an email
    }
  }
}
